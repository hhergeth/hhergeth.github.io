<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <title>Maps</title>
        <script src="data-frontline.js" type="text/javascript"></script>
        <script src="data-persons.js" type="text/javascript"></script>
        <script src="country-borders-geo.js" type="text/javascript"></script>
        <script src="historic_tile_info.js" type="text/javascript"></script>
        <script src="C:/Users/hherg/Desktop/historic tiles/map_annotations.js" type="text/javascript"></script>
        <script src="moment.min.js" type="text/javascript"></script>
        <script src="lightpick.js" type="text/javascript"></script>
        <script src="leaflet/leaflet.js" type="text/javascript"></script>
        <script src="leaflet.polylineDecorator.js" type="text/javascript"></script>
        <script src="Leaflet-MiniMap/Control.MiniMap.min.js" type="text/javascript"></script>
        <script src="leaflet-measure-path.js" type="text/javascript"></script>
        <script src="leaflet.contextmenu.min.js" type="text/javascript"></script>
        <link href="leaflet/leaflet.css" rel="stylesheet">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
        <link href="lightpick.css" rel="stylesheet">
        <link href="Leaflet-MiniMap/Control.MiniMap.min.css" rel="stylesheet">
        <link href="leaflet-measure-path.css" rel="stylesheet">
        <link href="leaflet.contextmenu.min.css" rel="stylesheet">
        <style>
            body {
                padding: 0;
                margin: 0;
            }

            html,
            body,
            #map {
                height: 100%;
                width: 100%;
            }

            .legend {
                line-height: 18px;
                color: #555;
            }

            .legend i {
                width: 35px;
                height: 6px;
                float: left;
                margin-top: 6px;
                margin-right: 8px;
                opacity: 1.0;
            }
            
            .timebutton {
                font-size:15px;
            }

            .frontline-label {
                position: absolute;
                font-size:14px;
                font-weight: 600;
                color:red;
                background: transparent;
                border: none;
                box-shadow: none;
            }
            
            .maptile-label-processed {
                color:black;
            }
            .maptile-label-unavailable {
                color:gray;
            }
            .maptile-label-available {
                color:red;
            }
            .maptile-label-processed, .maptile-label-unavailable, .maptile-label-available {
                position: absolute;
                font-size:17px;
                font-weight: 600;
                background: transparent;
                border: none;
                box-shadow: none;
            }
        </style>
    </head>
    <body>
        <div id="map" data-tap-disabled="true"></div>
        <div id="date-element">
            <button class="timebutton" onclick="btn_change_date(0, -1, 'days')">&lt;</button>
            <button class="timebutton" onclick="btn_change_date(0, -1, 'months')">&lt;&lt;</button>
            <input class="date-picker" id="pick1">
            <button class="timebutton" onclick="btn_change_date(0, +1, 'months')">>></button>
            <button class="timebutton" onclick="btn_change_date(0, +1, 'days')">></button>
            <button class="timebutton" onclick="btn_right()" id="btn_right"><i class="fa fa-arrow-right"></i></button>
            <button class="timebutton" onclick="btn_link(this)" id="btn_link"><i class="fa fa-link"></i></button>
            <button class="timebutton" onclick="btn_left()" id="btn_left"><i class="fa fa-arrow-left"></i></button>
            <button class="timebutton" onclick="btn_change_date(1, -1, 'days')">&lt;</button>
            <button class="timebutton" onclick="btn_change_date(1, -1, 'months')">&lt;&lt;</button>
            <input class="date-picker" id="pick2">
            <button class="timebutton" onclick="btn_change_date(1, +1, 'months')">>></button>
            <button class="timebutton" onclick="btn_change_date(1, +1, 'days')">></button>
        </div>
        <script>
            var base_year = 1939;
            var year_colors = ['#ffe119', '#3cb44b', '#e6194B', '#4363d8', '#f58231', '#469990', '#f032e6', '#fabebe'];
            var picker = null;
            var map = null;
            var person_groups = [];
            var frontline_group = null;
            var person_colors = ["green", "blue", "violet", "orange", "black"];
            var frontline_label_group = null;
            var historic_map_group = null;
            var historic_map_tile_label_group = null;
            var historic_tile_labels_shown = false;
            var ignore_map_remove = false;
            var circle_group = null;
            
            var storage  = window.localStorage;
            
            function getPersonColor(idx) {
                return person_colors[idx % person_colors.length];
            }
            
            function getYearColor(year) {
                year = Math.min(year, base_year + year_colors.length - 1);
                return year_colors[year - base_year];
            }
            
            function polygonArea(points) { 
                area = 0;         // Accumulates area in the loop
                j = points.length-1;  // The last vertex is the 'previous' one to the first

                for (i=0; i<points.length; i++)
                {
                    area = area +  (points[j][0]+points[i][0]) * (points[j][1]-points[i][1]); 
                    j = i;  //j is previous vertex to i
                }
                return area/2;
            }
            
            var getCentroid2 = function (arr) {
                var twoTimesSignedArea = 0;
                var cxTimes6SignedArea = 0;
                var cyTimes6SignedArea = 0;

                var length = arr.length

                var x = function (i) { return arr[i % length][0] };
                var y = function (i) { return arr[i % length][1] };

                for ( var i = 0; i < arr.length; i++) {
                    var twoSA = x(i)*y(i+1) - x(i+1)*y(i);
                    twoTimesSignedArea += twoSA;
                    cxTimes6SignedArea += (x(i) + x(i+1)) * twoSA;
                    cyTimes6SignedArea += (y(i) + y(i+1)) * twoSA;
                }
                var sixSignedArea = 3 * twoTimesSignedArea;
                return [ cxTimes6SignedArea / sixSignedArea, cyTimes6SignedArea / sixSignedArea];        
            }
            
            function get_dash(annotations) {
                var dashes = null;
                if(annotations.includes("k"))
                    dashes = "1, 0";
                if(annotations.includes("v"))
                    dashes = "4, 24";
                if(annotations.includes("f"))
                    dashes = "5, 5";
                if(annotations.includes("u"))
                    dashes = "40, 10";
                if(annotations.includes("t"))
                    dashes = "20, 30";
                return dashes;
            }
            
            function add_transition(latlng1, latlng2, date1, date2, colorf, annotations, group) {
                var opacity_line = 1.0;
                if(annotations.includes("?") || annotations.includes("o") || annotations.includes("z"))
                    opacity_line = 0.65;
            
                var dashes = get_dash(annotations);
                    
                var line = L.polyline([latlng1, latlng2], {
                    color: colorf,
                    opacity: opacity_line,
                    dashArray: dashes,
                    showMeasurements: true,
                    //measurementOptions: { showOnHover: true }
                }).addTo(group);
            
                line.formatDistance = function(d) {
                    var unit, distance_text;
                    if (d > 1000) {
                        d = d / 1000;
                        unit = 'km';
                    } else {
                        unit = 'm';
                    }
            
                    if (d < 100) {
                        distance_text = d.toFixed(1) + ' ' + unit;
                    } else {
                        distance_text = Math.round(d) + ' ' + unit;
                    }
                    
                    var f = 'D.MMM';
                    return moment(date1).format(f) + " - " + distance_text + " - " + moment(date2).format(f);
                }
                
                var arrowHead = L.polylineDecorator(line, {
                    patterns: [
                        {
                            offset: '100%',
                            repeat: 0,
                            symbol: L.Symbol.arrowHead({pixelSize: 18, polygon: false, pathOptions:{
                                stroke: true,
                                color: colorf,
                                opacity: opacity_line,
                            }})
                        }
                    ]
                }).addTo(group);
            }
            
            function legend_transit(a, text) {
                return '<svg height="12" width="43"> <g fill="none" stroke="black" stroke-width="4"> <path stroke-dasharray="' + get_dash(a) + '" d="M0 7 L35 7"></path></g> </svg>' + text;
            }
            
            function closest_front(total, front, date) {
                var date_new_front = new Date(front[0]);
                if(date < date_new_front)
                    return total;
                if(total == null)
                    return front;
                var date_total_front = new Date(total[0]);
                var difference_ms_new = date - date_new_front;
                var difference_ms_total = date - date_total_front;
                return difference_ms_new < difference_ms_total ? front : total;
            }
            
            function plot(date_start, date_end) {    
                var person_idx = 0;
                for (var person_name in data) {
                    var places = data[person_name].places;
                    var route = data[person_name].route;
                    
                    var transitions_group = new L.featureGroup();
                    var places_group = new L.featureGroup();
                    
                    var used_places = new Set();
                    
                    for (var idx = 0; idx < route.length - 1; idx++) {
                        var coords1 = route[idx + 0][1];
                        var coords2 = route[idx + 1][1];
                        var date1 = route[idx + 0][0];
                        var date2 = route[idx + 1][0];
                        var name1 = route[idx + 0][2];
                        var name2 = route[idx + 1][2];
                        
                        if(new moment(date1) <= new moment(date_end) && new moment(date_start) <= new moment(date2)) {
                            var color = getYearColor(new Date(date1).getFullYear());
                            add_transition(coords1, coords2, date1, date2, color, route[idx + 1][3], transitions_group);
                            
                            used_places.add(name1);
                            used_places.add(name2);
                        }
                    }
                    
                    var person_icon = new L.Icon({
                        iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-' + getPersonColor(person_idx) + '.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    });
                    
                    for (let  place_name of used_places) {
                        var latlng = places[place_name];
                        if(latlng != null) {
                            var marker = L.marker(latlng, {
                                title: place_name,
                                icon: person_icon
                            }).addTo(places_group).bindPopup(place_name);
                        }
                    }
                    
                    person_group = person_groups[person_name];
                    person_group.clearLayers();
                    places_group.addTo(person_group);
                    transitions_group.addTo(person_group);
                    
                    person_idx = person_idx + 1;
                }
                
                frontline_group.clearLayers();
                frontline_label_group.clearLayers();
                let front_start = frontline_data.reduce((total, v) => closest_front(total, v, date_start), null);
                let front_end = frontline_data.reduce((total, v) => closest_front(total, v, date_end), null);
                var fronts = new Set([front_start, front_end]);
                for (let front of fronts) {
                    if(front == null)
                        continue;
                    for(var idx = 0; idx < front[1].length; idx++) {
                        var polygon = L.polygon(front[1][idx], {color: 'red', opacity: 0.25}).addTo(frontline_group);
                        if (polygonArea(front[1][idx]) < 25)
                            continue;
                        var center = getCentroid2(front[1][idx]);//polygon.getBounds().getCenter()
                        var myTextLabel = L.marker(center, {
                            icon: L.divIcon({
                                className: 'frontline-label',
                                html: moment(front[0]).format('DD/MM/YY')
                            }),
                            draggable: false,
                            zIndexOffset: 1000
                        }).addTo(frontline_label_group);
                    }
                }
            }
                
            window.onload=function(){
                var osm = L.tileLayer('https://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png', {
                    maxZoom: 18,
                });
            
                map = L.map('map', {
                    zoomControl: false,
                    attributionControl: false,
                    contextmenu: true,
                    contextmenuItems: [{
                        text: 'Show coordinates',
                        callback: showCoordinates
                    }, {
                        text: 'Create Circle',
                        callback: addCircle
                    }, {
                        text: 'Remove All Circles',
                        callback: removeCircles
                    }]
                }).addLayer(osm);
                map.doubleClickZoom.disable();
                
                circle_group = new L.featureGroup();
                circle_group.addTo(map);
            
                for (var person_name in data) {
                    var person_group = L.layerGroup();
                    person_group.addTo(map);
                    person_groups[person_name] = person_group;
                }
                frontline_group = new L.featureGroup();
                frontline_group.addTo(map);
                person_groups["HKL"] = frontline_group;
                frontline_label_group = new L.featureGroup();
                frontline_label_group.addTo(frontline_group);
                
                var start_date = new Date(storage.getItem("start-date") || "1939-01-01");
                var end_date = new Date(storage.getItem("end-date") || "1950-01-01");
                
                plot(start_date, end_date);
                
                person_groups_html = [];
                var idx = 0;
                for(var entry_name in person_groups) {
                    var color_name = "red";
                    if(entry_name != "HKL") {
                        color_name = getPersonColor(idx);
                        idx = idx + 1;
                    }
                    var html_name = '<span style="color:' + color_name + '">' + entry_name + '</span>';
                    person_groups_html[html_name] = person_groups[entry_name]
                }    
                L.control.layers(null, person_groups_html,{collapsed:false, position: 'bottomleft'}).addTo(map);
                
                var global_bbox = null;
                map.eachLayer(function (layers) {
                    if (!(typeof layers.eachLayer === 'function'))
                        return;
                
                    layers.eachLayer(function (layer) {
                        if(layer.getBounds == null)
                            return;
                        var b = layer.getBounds();
                        if(global_bbox == null)
                            global_bbox = b;
                        else global_bbox = global_bbox.extend(b);
                    });
                });
                
                map.fitBounds(global_bbox);

                historic_map_group = new L.featureGroup(); 
                var historicTiles = L.tileLayer('C:/Users/hherg/Desktop/historic tiles/{z}/{x}/{y}.png', {
                    minZoom: 0, maxZoom: 14,
                    maxNativeZoom: 12
                }).addTo(historic_map_group);
                var baseLayers = {
                    "OSM": osm,
                    "Übersichtskarten 1:300.000": historic_map_group
                };
                var myCustomStyle = {
                    stroke: true,
                    fill: false,
                    color: "black",
                    width: 1.5,
                    opacity: 0.5
                }
                L.geoJson(country_data, {
                    clickable: false,
                    style: myCustomStyle
                }).addTo(historic_map_group);
                historic_map_tile_label_group = new L.featureGroup();
                for (let map_info of historic_map_info) {
                    var loc_center = [map_info[1] - 0.5, map_info[2] + 1];
                    cName = "unavailable";
                    var is_processed = historic_maps_processed.indexOf(map_info[0]) >= 0;
                    var is_available = map_info[5];
                    if(is_processed)
                        cName = 'processed';
                    if(!is_processed && is_available)
                        cName = 'available';

                    var myTextLabel = L.marker(loc_center, {
                        icon: L.divIcon({
                            className: 'maptile-label-'+cName,
                            html: map_info[3]
                        }),
                        draggable: false,
                        zIndexOffset: 1000
                    }).addTo(historic_map_tile_label_group);
                    if(map_info[4] != "")
                        myTextLabel.bindTooltip(map_info[4]);
                }
                
                var historic_map_tiles_name = "Übersichtskarten Names";
                L.control.layers(baseLayers, {"Übersichtskarten Names": historic_map_tile_label_group}, {position: 'bottomleft'}).addTo(map);
                
                map.on({
                    overlayadd: function(e1) {
                        if (e1.name === historic_map_tiles_name){
                            historic_tile_labels_shown = true;
                        }
                    },
                    overlayremove: function(e) {
                        if (e.name === historic_map_tiles_name && !ignore_map_remove) {
                            historic_tile_labels_shown = false;
                        }
                    }
                });
                    
                /*L.control.scale({maxWidth: 200, position: 'bottomright'}).addTo(map);*/
                
                var legend = L.control({position: 'topright'});
                legend.onAdd = function(map) {
                    var div = L.DomUtil.create('div', 'info legend');
                    var labels = [];
                    
                    /* years */
                    labels.push('<strong>Years</strong>');
                    for (var i = 0; i < year_colors.length; i++) {
                        labels.push('<i style="background:' + year_colors[i] + '"></i> ' + (base_year + i));
                    }
                    
                    labels.push('<br>');
                    
                    /* dashes */
                    var transits = [["k", "Fight"], ["v", "Hurt"], ["f", "Run"], ["u", "Leave"], ["t", "Trst"]];
                    labels.push('<strong>Transits</strong>');
                    for (var i = 0; i < transits.length; i++) {
                        labels.push(legend_transit(transits[i][0], transits[i][1]));
                    }
                    
                    div.innerHTML = labels.join('<br>');
                    return div;
                };
                legend.addTo(map);
                
                var timeselector = L.control({position: 'topleft'});
                timeselector.onAdd = function(map) {        
                    return document.getElementById("date-element");
                };
                timeselector.addTo(map);
                
                picker = new Lightpick({
                    field: document.getElementById('pick1'),
                    secondField: document.getElementById('pick2'),
                    singleDate: false,
                    repick: true,
                    startDate: start_date,
                    endDate: end_date,
                    onSelect: function(start, end){
                        plot(picker.getStartDate().toDate(), picker.getEndDate().toDate());
                        storage.setItem("start-date", picker.getStartDate().toDate().toISOString());
                        storage.setItem("end-date", picker.getEndDate().toDate().toISOString());
                    }
                });
                
                var osm2 = new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {minZoom: 0, maxZoom: 13, attribution: "" });
                var miniMap = new L.Control.MiniMap(osm2, {
                    centerFixed: [50.666667, 17.933333],
                    zoomLevelFixed: 2,
                    width: 250,
                    autoToggleDisplay: true,
                }).addTo(map);
                
                map.on('zoomend', () => toggleLabelsZoom(false));
                toggleLabelsZoom(true);
            }
            
            function showCoordinates(e) {
                alert(e.latlng);
            }
            
            function addCircle(e) {
                var distance_km = prompt("Radius in km", 1.0);
                if (distance_km != null) {
                    var circle = L.circle(e.latlng, distance_km * 1000, {
                        contextmenu: true,
                        contextmenuItems: [{
                            text: 'Change Radius',
                            callback: e => changeRadius(e, circle),
                            index: 0
                        }, {
                            separator: true,
                            index: 1
                        }]
                    }).addTo(circle_group);
                }
            }
            
            function removeCircles(e) {
                circle_group.clearLayers();
            }
            
            function changeRadius(e, circle) {
                var distance_km = prompt("Radius in km", 1.0);
                if (distance_km != null) {
                    circle.setRadius(distance_km * 1000);
                }
            }
            
            function toggleLabelsZoom(inital) {
                if (map.getZoom() < 4){
                    frontline_group.removeLayer(frontline_label_group);
                }
                else frontline_group.addLayer(frontline_label_group);
                
                if(!inital && historic_tile_labels_shown) {
                    if (map.getZoom() < 5){
                        ignore_map_remove = true;
                        map.removeLayer(historic_map_tile_label_group);
                        ignore_map_remove = false;
                    }
                    else map.addLayer(historic_map_tile_label_group);
                }
            }
            
            function btn_link(btn) {
                btn.children[0].className = btn.children[0].className == "fa fa-unlink" ? "fa fa-link" : "fa fa-unlink";
            }
            
            function btn_change_date(idx_date, delta, ty) {
                if (event.ctrlKey)
                    ty = ty == "days" ? "weeks" : "years";
            
                var start = picker.getStartDate().clone();
                var end = picker.getEndDate().clone();
                var linked = document.getElementById("btn_link").children[0].className == "fa fa-link";
            
                if(linked || idx_date == 0)
                    start.add(delta, ty);
            
                if(linked || idx_date == 1)
                    end.add(delta, ty);
            
                picker.setDateRange(start, end);
            }
            
            function btn_right() {
                var start = picker.getStartDate().clone();
                picker.setDateRange(start, start);
            }
            
            function btn_left() {
                var end = picker.getEndDate().clone();
                picker.setDateRange(end, end);
            }
        </script>
    </body>
</html>